<div class="learning-session-container">
  <!-- Encabezado Superior -->
  <header class="session-header">
    <div class="header-controls">
      <app-emotion-indicator [emotion]="currentEmotion" [confidence]="emotionConfidence"></app-emotion-indicator>
    </div>
  </header>

  <!-- Contenido Principal -->
  <main class="content-feed" #messagesContainer>

    <!-- Estado de Carga Inicial -->
    <div *ngIf="isLoading" class="skeleton-loader fade-in">
      <div class="skeleton-card"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line short"></div>
      <p class="loading-text">{{ i18n.t('learningSession.preparingLesson') }}</p>
    </div>

    <!-- Stream de Contenido -->
    <div *ngFor="let chunk of displayedChunks" class="chunk-card fade-in">

      <!-- Chunk de Texto -->
      <div *ngIf="chunk.type === 'text'" class="text-content">
        <p>{{ chunk.content }}</p>
      </div>

      <!-- Image Prompt Chunk (Visual) -->
      <div *ngIf="chunk.type === 'image_prompt'" class="visual-content">
        <div class="image-placeholder">
          <!-- Show actual image if image_url is provided -->
          <div class="image-frame" *ngIf="chunk.image_url">
            <img [src]="chunk.image_url" [alt]="chunk.content" class="generated-image">
          </div>
          <!-- Show icon placeholder if no image_url -->
          <span class="icon" *ngIf="!chunk.image_url">ğŸ–¼ï¸</span>
          <p class="caption">{{ chunk.content }}</p>
        </div>
      </div>

      <!-- Video Chunk (NEW for Demo Mode) -->
      <div *ngIf="chunk.type === 'video_url'" class="video-content">
        <div class="video-wrapper">
          <video controls autoplay muted [src]="chunk.content" class="lesson-video"></video>
          <p class="video-caption" *ngIf="chunk.caption">
            <i class="bi bi-play-circle-fill"></i> {{ chunk.caption }}
          </p>
        </div>
      </div>

      <!-- User Question Display -->
      <div *ngIf="chunk.type === 'user_question'" class="user-question-bubble">
        <div class="avatar">ğŸ‘¤</div>
        <div class="question-text">{{ chunk.content }}</div>
      </div>

      <!-- Tutor Answer Display -->
      <div *ngIf="chunk.type === 'tutor_answer'" class="tutor-answer-bubble">
        <div class="avatar">ğŸ¤–</div>
        <div class="answer-text">{{ chunk.content }}</div>
      </div>

    </div>
  </main>

  <!-- Vista Previa de CÃ¡mara -->
  <div class="camera-preview" [class.error]="cameraError" [class.loading]="cameraLoading">
    <!-- Video element - SIEMPRE en el DOM -->
    <video #videoElement autoplay playsinline muted [style.display]="isCameraActive ? 'block' : 'none'">
    </video>

    <!-- Loading state -->
    <div class="camera-loading" *ngIf="cameraLoading">
      <div class="spinner"></div>
      <p>Iniciando cÃ¡mara...</p>
    </div>

    <!-- Error state -->
    <div class="camera-error" *ngIf="cameraError && !cameraLoading">
      <span class="error-icon">âš ï¸</span>
      <p>{{ cameraError }}</p>

      <!-- Retry button if camera might work -->
      <button *ngIf="!noCameraAvailable" class="retry-btn" (click)="handleCameraPermissions()">
        ğŸ”„ Reintentar
      </button>

      <!-- Demo mode button if no camera detected -->
      <button *ngIf="noCameraAvailable" class="demo-btn" (click)="continueWithDemoMode()">
        ğŸ­ Continuar sin cÃ¡mara (modo demo)
      </button>
    </div>

    <!-- Camera label -->
    <div class="camera-label" *ngIf="isCameraActive">
      ğŸ“¹ {{ i18n.t('learningSession.cameraActive') }}
      <span class="emotion-badge" *ngIf="currentEmotion !== EmotionState.Neutral">
        {{ currentEmotion }}
      </span>
    </div>
  </div>

  <!-- Overlay de InterrupciÃ³n -->
  <div *ngIf="isPaused && !isInteractionBarCollapsed" class="interruption-overlay fade-in">
    <div class="overlay-content">
      <h2>{{ i18n.t('learningSession.interruption.title') }} ğŸ˜•</h2>
      <p>{{ i18n.t('learningSession.interruption.message') }}</p>
      <button (click)="resumeSession()" class="btn-primary">{{ i18n.t('learningSession.interruption.continueBtn')
        }}</button>
      <button (click)="pauseForQuestion()" class="btn-secondary">{{
        i18n.t('learningSession.interruption.askQuestionBtn') }}</button>
    </div>
  </div>

  <!-- Interaction Bar -->
  <div class="interaction-bar" [class.collapsed]="isInteractionBarCollapsed" *ngIf="sessionStarted">
    <div class="bar-header">
      <div class="quick-actions">
        <button (click)="pauseForQuestion()" *ngIf="!isPaused">
          â“ {{ i18n.t('learningSession.askQuestion') }}
        </button>
        <button (click)="resumeSession()" *ngIf="isPaused" class="btn-primary">
          â–¶ï¸ {{ i18n.t('learningSession.resumeSession') }}
        </button>
        <button (click)="finishSession()" class="btn-finish">
          âœ“ {{ i18n.t('learningSession.finishSession') }}
        </button>
      </div>
      <button class="toggle-btn" (click)="isInteractionBarCollapsed = !isInteractionBarCollapsed">
        {{ isInteractionBarCollapsed ? 'â–²' : 'â–¼' }}
      </button>
    </div>

    <div class="question-input" *ngIf="!isInteractionBarCollapsed">
      <textarea [(ngModel)]="userQuestion" [placeholder]="i18n.t('learningSession.askQuestionPlaceholder')"
        (keydown.ctrl.enter)="sendQuestion()" [disabled]="waitingForAnswer"></textarea>

      <button class="send-btn" (click)="sendQuestion()" [disabled]="!userQuestion.trim() || waitingForAnswer">
        {{ waitingForAnswer ? 'â³' : 'ğŸ“¤' }}
        {{ i18n.t('learningSession.send') }}
      </button>
    </div>

    <small class="hint" *ngIf="waitingForAnswer">
      {{ i18n.t('learningSession.tutorThinking') }}
    </small>

    <!-- Error notification -->
    <div class="error-notification" *ngIf="backendError">
      <span class="error-icon">âš ï¸</span>
      <div class="error-content">
        <strong>{{ i18n.t('learningSession.errorTitle') }}</strong>
        <p>{{ backendError }}</p>
      </div>
      <button class="close-error" (click)="backendError = null">âœ•</button>
    </div>
  </div>

</div>