<div class="learning-session-page">
    <!-- Camera Permission Modal -->
    @if (showCameraPermissionModal && !isCameraActive) {
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">{{ i18n.t('learningSession.cameraPermission.title') }}</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="permission-icon mb-4">
                        <i class="bi bi-camera-video display-1 text-primary"></i>
                    </div>
                    <h6 class="mb-3">{{ i18n.t('learningSession.cameraPermission.why') }}</h6>
                    <ul class="list-unstyled text-start">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            {{ i18n.t('learningSession.cameraPermission.reason1') }}
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            {{ i18n.t('learningSession.cameraPermission.reason2') }}
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            {{ i18n.t('learningSession.cameraPermission.reason3') }}
                        </li>
                    </ul>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-shield-check me-2"></i>
                        {{ i18n.t('learningSession.cameraPermission.privacy') }}
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-secondary" (click)="router.navigate(['/dashboard'])">
                        {{ i18n.t('learningSession.cameraPermission.notNow') }}
                    </button>
                    <button type="button" class="btn btn-primary" (click)="startLearningSession()">
                        <i class="bi bi-camera-video me-2"></i>
                        {{ i18n.t('learningSession.cameraPermission.allow') }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Loading State -->
    @if (isLoading) {
    <div class="loading-container">
        <app-loading-spinner></app-loading-spinner>
        <p class="mt-3">{{ i18n.t('learningSession.loading') }}</p>
    </div>
    }

    <!-- Main Learning Session -->
    @if (!isLoading && lesson && lesson.curriculum) {
    <div class="session-container">
        <!-- Header with Progress -->
        <div class="session-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-1">{{ currentTopic?.title || lesson.title }}</h5>
                        <small class="text-muted">
                            {{ i18n.t('learningSession.topic') }} {{ getCurrentTopicNumber() }}
                        </small>
                    </div>
                    <div class="col-md-4 text-end">
                        <!-- Emotion Indicator -->
                        @if (currentEmotion) {
                        <app-emotion-indicator [emotion]="currentEmotion.state"></app-emotion-indicator>
                        }
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="progress mt-3" style="height: 6px;">
                    <div class="progress-bar bg-primary" role="progressbar" [style.width.%]="getProgressPercentage()"
                        [attr.aria-valuenow]="getProgressPercentage()" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="messages-area" #messagesContainer>
            <div class="container">
                @for (message of sessionHistory; track message.id) {
                <div class="message-wrapper"
                    [class.ai-message]="message.type === 'ai' || message.type === 'question' || message.type === 'encouragement'"
                    [class.user-message]="message.type === 'user'" [class.system-message]="message.type === 'system'">

                    <!-- AI/Question/Encouragement Messages -->
                    @if (message.type === 'ai' || message.type === 'question' || message.type === 'encouragement') {
                    <div class="message ai">
                        <div class="message-avatar">
                            @if (message.type === 'question') {
                            <i class="bi bi-question-circle"></i>
                            } @else if (message.type === 'encouragement') {
                            <i class="bi bi-star-fill"></i>
                            } @else {
                            <i class="bi bi-robot"></i>
                            }
                        </div>
                        <div class="message-content">
                            <div class="message-bubble">
                                {{ message.content }}
                                @if (message.adapted) {
                                <div class="adaptation-badge">
                                    <i class="bi bi-lightning-fill me-1"></i>
                                    {{ i18n.t('learningSession.adapted') }}
                                </div>
                                }
                            </div>
                            @if (message.timestamp) {
                            <small class="message-time">{{ message.timestamp | date:'shortTime' }}</small>
                            }
                        </div>
                    </div>
                    }

                    <!-- System Messages -->
                    @if (message.type === 'system') {
                    <div class="message system">
                        <div class="system-message-content">
                            <i class="bi bi-info-circle me-2"></i>
                            {{ message.content }}
                        </div>
                    </div>
                    }
                </div>
                }

                <!-- Loading more topics indicator -->
                @if (isGeneratingMoreTopics) {
                <div class="message-wrapper ai-message">
                    <div class="message ai">
                        <div class="message-avatar">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-bubble">
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="session-actions">
            <div class="container">
                @if (!isWaitingForContinue && !showCompletionModal) {
                <!-- Continue Button -->
                <button class="btn btn-primary btn-lg w-100" (click)="showNextMessage()">
                    <i class="bi bi-arrow-right-circle me-2"></i>
                    {{ i18n.t('common.continue') }}
                </button>
                }

                @if (isWaitingForContinue) {
                <!-- Continue or Finish Options -->
                <div class="continue-options">
                    <h6 class="text-center mb-3">{{ i18n.t('learningSession.continueOrFinish.title') }}</h6>
                    <p class="text-center text-muted mb-4">
                        {{ i18n.t('learningSession.continueOrFinish.subtitle') }}
                    </p>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-lg w-100" (click)="continueWithMoreTopics()"
                                [disabled]="isGeneratingMoreTopics">
                                <i class="bi bi-plus-circle me-2"></i>
                                {{ i18n.t('learningSession.continueOrFinish.continue') }}
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-success btn-lg w-100" (click)="finishLesson()">
                                <i class="bi bi-check-circle me-2"></i>
                                {{ i18n.t('learningSession.continueOrFinish.finish') }}
                            </button>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
    }

    <!-- Completion Modal -->
    @if (showCompletionModal) {
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">
                        <i class="bi bi-trophy-fill text-warning me-2"></i>
                        {{ i18n.t('learningSession.completion.title') }}
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="completion-icon mb-4">
                        <i class="bi bi-check-circle-fill display-1 text-success"></i>
                    </div>
                    <h4 class="mb-3">{{ i18n.t('learningSession.completion.congrats') }}</h4>
                    <p class="text-muted">
                        {{ i18n.t('learningSession.completion.message') }}
                    </p>
                    @if (lesson) {
                    <div class="lesson-stats mt-4">
                        <div class="row">
                            <div class="col-6">
                                <div class="stat-card">
                                    <i class="bi bi-book text-primary"></i>
                                    <h5>{{ lesson.curriculum?.totalTopics || 0 }}</h5>
                                    <small>{{ i18n.t('learningSession.completion.topicsCompleted') }}</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card">
                                    <i class="bi bi-clock text-info"></i>
                                    <h5>{{ lesson.estimatedMinutes }}</h5>
                                    <small>{{ i18n.t('learningSession.completion.minutes') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg" (click)="goToDashboard()">
                        <i class="bi bi-house me-2"></i>
                        {{ i18n.t('learningSession.completion.goToDashboard') }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Hidden Video Element for Camera (Always present) -->
    <video #videoElement autoplay playsinline muted class="camera-feed"
        [style.display]="isCameraActive ? 'block' : 'none'"></video>
</div>